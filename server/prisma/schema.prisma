generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  admin
  manager
  staff

  @@map("user_role")
}

enum GenderType {
  male
  female
  other

  @@map("gender_type")
}

enum DeploymentStatus {
  active
  ended
  pending
  terminated

  @@map("deployment_status")
}

enum IncidentSeverity {
  low
  medium
  high
  critical

  @@map("incident_severity")
}

enum IncidentStatus {
  open
  in_progress
  closed

  @@map("incident_status")
}

enum PermitType {
  initial
  extension
  reissue

  @@map("permit_type")
}

enum HealthCheckType {
  entry
  mo6           @map("6mo")
  mo18          @map("18mo")
  mo30          @map("30mo")
  supplementary

  @@map("health_check_type")
}

enum HealthCheckResult {
  pass
  fail
  pending

  @@map("health_check_result")
}

enum NationalityType {
  PH
  ID
  VN
  TH
  OTHER

  @@map("nationality_type")
}

enum WorkerCategory {
  general
  intermediate_skilled
  professional

  @@map("worker_category")
}

enum ManagementSourceType {
  direct_hiring
  re_hiring
  transfer_in
  replacement

  @@map("management_source_type")
}

enum ServiceStatus {
  active_service
  contract_terminated
  runaway
  transferred_out
  commission_ended

  @@map("service_status")
}

enum StaffRoleType {
  sales_agent
  admin_staff
  bilingual_staff
  customer_service
  accountant

  @@map("staff_role_type")
}

enum InsuranceType {
  labor
  health
  accident

  @@map("insurance_type")
}

enum AddressType {
  approval_letter
  medical_pickup
  actual_residence
  arc
  work

  @@map("address_type")
}

enum JobOrderStatus {
  open
  processing
  completed
  cancelled

  @@map("job_order_status")
}

enum CandidateResult {
  selected
  rejected
  failed_medical
  pending

  @@map("candidate_result")
}

enum WorkerEventType {
  RUNAWAY
  TRANSFER_OUT
  DEPARTURE
  DOMESTIC_HIRE
  CONTRACT_RENEWAL
  DEATH
  OTHER

  @@map("worker_event_type")
}

// Models

model InternalUser {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         UserRole @default(staff)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations (Created By / Updated By)
  createdEmployers Employer[]          @relation("EmployerCreatedBy")
  updatedEmployers Employer[]          @relation("EmployerUpdatedBy")
  createdWorkers   Worker[]            @relation("WorkerCreatedBy")
  updatedWorkers   Worker[]            @relation("WorkerUpdatedBy")
  createdJobOrders JobOrder[]          @relation("JobOrderCreatedBy")
  updatedJobOrders JobOrder[]          @relation("JobOrderUpdatedBy")
  // ... (Many other relations would be here, omitting for brevity in favor of core logic, 
  // but strictly strictly speaking, Prisma requires inverse relations for all. 
  // To keep schema manageable, I will define the mandatory ones and maybe skip inverse 
  // on Audit fields if not strictly needed for querying USER -> ALL RECORDS they created.)
  // Actually, let's include the key operational ones.
  assignedServices ServiceAssignment[] @relation("ServiceAssignedUser")
  assignedLeads    Lead[]              @relation("LeadAssignedUser")

  // Comments & Mentions
  comments         SystemComment[]  @relation("CommentAuthor")
  mentionsReceived CommentMention[] @relation("MentionedUser")

  @@map("internal_users")
}

model Employer {
  id        String  @id @default(uuid()) @db.Uuid
  // [Added] Business ID
  code      String? @unique @db.VarChar(20) // 雇主編號
  shortName String? @map("short_name") @db.VarChar(50) // 雇主簡稱

  taxId         String? @unique @map("tax_id") @db.VarChar(20)
  companyName   String  @map("company_name") @db.VarChar(100)
  companyNameEn String? @map("company_name_en") @db.VarChar(100)

  // Responsible Person (Common leader name, or for Individual it is the Employer)
  responsiblePerson String? @map("responsible_person") @db.VarChar(50)

  address        String? @db.Text
  addressEn      String? @map("address_en") @db.Text
  invoiceAddress String? @map("invoice_address") @db.Text

  // [Added] Other Addresses
  taxAddress        String? @map("tax_address") @db.Text // 稅籍地址
  healthBillAddress String? @map("health_bill_address") @db.Text // 健保帳單地址
  healthBillZip     String? @map("health_bill_zip") @db.VarChar(10) // 健保郵遞區號

  phoneNumber String? @map("phone_number") @db.VarChar(20)
  email       String? @db.VarChar(100)

  contactPerson String? @map("contact_person") @db.VarChar(50)
  contactPhone  String? @map("contact_phone") @db.VarChar(20)

  // [Added] Internal Management
  referrer      String?   @db.VarChar(50) // 介紹人
  terminateDate DateTime? @map("terminate_date") @db.Date // 終止委任日期

  // Relations to Details
  corporateInfo  CorporateInfo?
  individualInfo IndividualInfo?

  // Existing Relations
  recruitmentLetters EmployerRecruitmentLetter[]
  deployments        Deployment[]
  permitDocuments    PermitDocument[]
  incidents          Incident[]
  serviceAssignments ServiceAssignment[]
  jobOrders          JobOrder[]
  factories          EmployerFactory[] // [Added] Factories

  createdBy     String?       @map("created_by") @db.Uuid
  updatedBy     String?       @map("updated_by") @db.Uuid
  createdByUser InternalUser? @relation("EmployerCreatedBy", fields: [createdBy], references: [id])
  updatedByUser InternalUser? @relation("EmployerUpdatedBy", fields: [updatedBy], references: [id])

  // CRM & Conversion
  originLeadId String? @unique @map("origin_lead_id") @db.Uuid
  originLead   Lead?   @relation("LeadToEmployer", fields: [originLeadId], references: [id])

  allocationRate       Decimal?  @map("allocation_rate") @db.Decimal(5, 4)
  complianceStandard   String?   @map("compliance_standard") @db.VarChar(50)
  zeroFeeEffectiveDate DateTime? @map("zero_fee_effective_date") @db.Date
  industryAttributes   Json?     @map("industry_attributes")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  laborCounts EmployerLaborCount[]
  industryRecognitions IndustryRecognition[]
  recruitmentProofs    RecruitmentProof[]

  @@map("employers")
}

model Lead {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyName   String  @map("company_name") @db.VarChar(100)
  taxId         String? @map("tax_id") @db.VarChar(20)
  contactPerson String? @map("contact_person") @db.VarChar(50)
  phone         String? @db.VarChar(20)
  email         String? @db.VarChar(100)
  address       String? @db.Text
  industry      String? @db.VarChar(50)
  status        String  @default("NEW") // NEW, CONTACTED, NEGOTIATING, WON, LOST

  estimatedWorkerCount Int? @map("estimated_worker_count")

  // Tracking
  assignedTo   String?       @map("assigned_to") @db.Uuid
  assignedUser InternalUser? @relation("LeadAssignedUser", fields: [assignedTo], references: [id])

  // Conversion
  convertedEmployer Employer? @relation("LeadToEmployer")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("leads")
}

model EmployerFactory {
  id         String   @id @default(uuid()) @db.Uuid
  employerId String   @map("employer_id") @db.Uuid
  employer   Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  name         String  @map("name") @db.VarChar(100) // 廠名 (如：一廠)
  factoryRegNo String? @map("factory_reg_no") @db.VarChar(50) // 該廠的工廠登記證

  address   String? @db.Text
  addressEn String? @map("address_en") @db.Text
  zipCode   String? @map("zip_code") @db.VarChar(10)
  cityCode  String? @map("city_code") @db.VarChar(10)

  laborCount   Int? @default(0) // 該廠本勞人數
  foreignCount Int? @default(0) // 該廠外勞人數

  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  deployments Deployment[] 
  industryRecognitions IndustryRecognition[] 


  @@map("employer_factories")
}

model EmployerLaborCount {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employerId String @map("employer_id") @db.Uuid
  year       Int
  month      Int
  count      Int    @default(0) // Internal labor count

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@unique([employerId, year, month])
  @@map("employer_labor_counts")
}

model CorporateInfo {
  id         String   @id @default(uuid()) @db.Uuid
  employerId String   @unique @map("employer_id") @db.Uuid
  employer   Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  factoryRegistrationNo String?  @map("factory_registration_no") @db.VarChar(50)
  factoryRegistrationId String?  @map("factory_registration_id") @db.VarChar(50)
  factoryAddress        String?  @map("factory_address") @db.Text
  factoryAddressEn      String?  @map("factory_address_en") @db.Text
  industryType          String?  @map("industry_type") @db.VarChar(50)
  industryCode          String?  @map("industry_code") @db.VarChar(20)
  capital               Decimal? @db.Decimal(15, 2)
  laborInsuranceNo      String?  @map("labor_insurance_no") @db.VarChar(50)
  laborInsuranceId      String?  @map("labor_insurance_id") @db.VarChar(50)
  healthInsuranceUnitNo String?  @map("health_insurance_unit_no") @db.VarChar(50)
  healthInsuranceId     String?  @map("health_insurance_id") @db.VarChar(50)
  securityFeeAccount    String?  @map("security_fee_account") @db.VarChar(50) // Employment Security Fee Account
  faxNumber             String?  @map("fax_number") @db.VarChar(20)

  // Institution Specifics
  institutionCode String? @map("institution_code") @db.VarChar(50)
  bedCount        Int?    @map("bed_count")

  @@map("corporate_info")
}

model IndividualInfo {
  id         String   @id @default(uuid()) @db.Uuid
  employerId String   @unique @map("employer_id") @db.Uuid
  employer   Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  responsiblePersonDob    DateTime? @map("responsible_person_dob") @db.Date
  responsiblePersonIdNo   String?   @map("responsible_person_id_no") @db.VarChar(20)
  responsiblePersonFather String?   @map("responsible_person_father_name") @db.VarChar(50)
  responsiblePersonMother String?   @map("responsible_person_mother_name") @db.VarChar(50)
  responsiblePersonSpouse String?   @map("responsible_person_spouse") @db.VarChar(50)

  // [Added] Detailed Individual Info
  englishName  String? @map("english_name") @db.VarChar(100) // 負責人英文名
  birthPlace   String? @map("birth_place") @db.VarChar(50)
  birthPlaceEn String? @map("birth_place_en") @db.VarChar(100)

  // 戶籍地址
  residenceAddress  String? @map("residence_address") @db.Text
  residenceZip      String? @map("residence_zip") @db.VarChar(10)
  residenceCityCode String? @map("residence_city_code") @db.VarChar(10)

  idIssueDate      DateTime? @map("id_issue_date") @db.Date
  idIssuePlace     String?   @map("id_issue_place") @db.VarChar(50)
  militaryStatus   String?   @map("military_status") @db.VarChar(20)
  militaryStatusEn String?   @map("military_status_en") @db.VarChar(50)

  // Home Care Specifics
  patientName  String? @map("patient_name") @db.VarChar(50)
  patientIdNo  String? @map("patient_id_no") @db.VarChar(20)
  careAddress  String? @map("care_address") @db.Text
  relationship String? @map("relationship") @db.VarChar(50)

  @@map("individual_info")
}

model Worker {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  englishName String          @map("english_name") @db.VarChar(100)
  chineseName String?         @map("chinese_name") @db.VarChar(50)
  dob         DateTime        @db.Date
  nationality NationalityType
  category    WorkerCategory  @default(general)
  gender      GenderType?

  mobilePhone    String?   @map("mobile_phone") @db.VarChar(50)
  foreignAddress String?   @map("foreign_address") @db.Text
  maritalStatus  String?   @map("marital_status") @db.VarChar(20)
  marriageDate   DateTime? @map("marriage_date") @db.Date
  divorceDate    DateTime? @map("divorce_date") @db.Date
  height         Decimal?  @db.Decimal(5, 2)
  weight         Decimal?  @db.Decimal(5, 2)
  birthPlace     String?   @map("birth_place") @db.VarChar(100)
  educationLevel String?   @map("education_level") @db.VarChar(50)
  spouseName     String?   @map("spouse_name") @db.VarChar(100)

  overseasContactPhone  String? @map("overseas_contact_phone") @db.VarChar(50)
  overseasFamilyContact String? @map("overseas_family_contact") @db.VarChar(100)

  bankAccountNo String?  @map("bank_account_no") @db.VarChar(50)
  bankCode      String?  @map("bank_code") @db.VarChar(20)
  loanBank      String?  @map("loan_bank") @db.VarChar(50)
  loanAmount    Decimal? @map("loan_amount") @db.Decimal(10, 2)

  flightArrivalInfo    String? @map("flight_arrival_info") @db.VarChar(100)
  oneStopServiceSerial String? @map("one_stop_service_serial") @db.VarChar(50)
  flightDeparture      String? @map("flight_departure") @db.VarChar(20)

  createdBy     String?       @map("created_by") @db.Uuid
  updatedBy     String?       @map("updated_by") @db.Uuid
  createdByUser InternalUser? @relation("WorkerCreatedBy", fields: [createdBy], references: [id])
  updatedByUser InternalUser? @relation("WorkerUpdatedBy", fields: [updatedBy], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  events              WorkerEvent[]
  passports           WorkerPassport[]
  arcs                WorkerArc[]
  deployments         Deployment[]
  healthChecks        HealthCheck[]
  incidents           Incident[]
  serviceAssignments  ServiceAssignment[]
  insurances          WorkerInsurance[]
  addressHistory      WorkerAddressHistory[]
  interviewCandidates InterviewCandidate[]

  @@map("workers")
}

model EmployerRecruitmentLetter {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employerId    String   @map("employer_id") @db.Uuid
  
  // --- 1. 最終產出 (招募函本身) ---
  letterNumber  String   @unique @map("letter_number") @db.VarChar(50) // 發文號碼 (勞動發事字...)
  issueDate     DateTime @map("issue_date") @db.Date // 發文日期
  expiryDate    DateTime @map("expiry_date") @db.Date // 招募效期
  validUntil    DateTime @map("valid_until") @db.Date @default(now()) // 有效期限 (通常同 expiryDate) - Added default to avoid migration issue on existing rows if any

  // --- [Phase 1 New Relations] ---
  industryRecognitionId String?              @map("industry_recognition_id") @db.Uuid
  industryRecognition   IndustryRecognition? @relation(fields: [industryRecognitionId], references: [id])

  recruitmentProofId String?           @map("recruitment_proof_id") @db.Uuid
  recruitmentProof   RecruitmentProof? @relation(fields: [recruitmentProofId], references: [id])

  // --- 2. 步驟一：工業局核定 (Industrial Bureau) ---
  // [DEPRECATED] Use relation industryRecognition instead
  // 證明你是3K產業，並核定級別 (A+, A, B, C, D)
  industrialBureauRef   String?  @map("industrial_bureau_ref") @db.VarChar(50) // 工業局核定函號
  industrialBureauDate  DateTime? @map("industrial_bureau_date") @db.Date // 工業局發文日
  industryTier          String?   @map("industry_tier") @db.VarChar(10) // 核定級別 (e.g., "B級")

  // --- 3. 步驟二：國內求才 (Domestic Recruitment) ---
  // 必須先去公立就業服務站求才，拿到「求才證明書」
  domesticRecruitmentRef String? @map("domestic_recruitment_ref") @db.VarChar(50) // [新] 求才證明書序號
  domesticRecruitmentDate DateTime? @map("domestic_recruitment_date") @db.Date // [新] 求才登記日/證明書發文日
  
  // --- 4. 步驟三：規費繳納 (Review Fee) ---
  // 申請招募許可前，要去郵局劃撥審查費
  reviewFeeReceiptNo     String? @map("review_fee_receipt_no") @db.VarChar(50) // [新] 審查費收據號碼 (郵政劃撥單號)
  reviewFeePayDate       DateTime? @map("review_fee_pay_date") @db.Date // [新] 繳費日期
  reviewFeeAmount        Int     @default(200) @map("review_fee_amount") // 金額 (通常每人200元)

  // --- 5. 名額與計算 ---
  approvedQuota Int      @default(0) @map("approved_quota") // 核准名額 (總計)
  usedQuota     Int      @default(0) @map("used_quota")     // 已用名額 (快取)
  
  // Legacy / Details
  submissionDate         DateTime? @map("submission_date") @db.Date // 送件日 (行政填寫)
  laborMinistryReceiptDate DateTime? @map("labor_ministry_receipt_date") @db.Date // 勞動部收文日期
  
  // --- Legacy / Details ---
  issueUnit     String?  @default("勞動部") @map("issue_unit") @db.VarChar(50) // 發文單位
  issueWord     String?  @default("勞動發事字") @map("issue_word") @db.VarChar(50) // 發文字
  caseNumber    String?  @map("case_number") @db.VarChar(50) // 案號

  // Hierarchy (for split letters)
  parentLetterId String? @map("parent_letter_id") @db.Uuid 
  parentLetter   EmployerRecruitmentLetter? @relation("LetterHierarchy", fields: [parentLetterId], references: [id])
  childLetters   EmployerRecruitmentLetter[] @relation("LetterHierarchy")

  // Work Location & Job Info
  workAddress   String?  @map("work_address") @db.Text // 外勞工作地址
  jobType       String?  @map("job_type") @db.VarChar(50) // 工種代碼 (e.g., 製造業勞工)
  jobTitle      String?  @map("job_title") @db.VarChar(100) // 職務名稱 (e.g., 塑膠產品製造職員)
  industryCode  String?  @map("industry_code") @db.VarChar(50) // 所屬行業別 (e.g., 22->塑膠製品)

  // Project / Bureau Info
  projectCode   String?  @map("project_code") @db.VarChar(50) // 專案代號 (e.g., x1-03...)
  // industrialBureauRef removed as it is defined above
  
  // Quota Management - Moved to top
  
  // Gender Constraints (Legacy support)
  quotaMale     Int      @default(0) @map("quota_male")
  quotaFemale   Int      @default(0) @map("quota_female")

  // Other Attributes
  recruitmentType String? @map("recruitment_type") @db.VarChar(20) // 招募別 (初招/重招/遞補)
  nationality     String? @map("nationality") @db.VarChar(20) // 指定國籍 (印尼/越南...)
  canCirculate    Boolean @default(true) @map("can_circulate") // 可循環否
  remarks         String? @db.Text // 備註說明

  // Relations
  employer    Employer     @relation(fields: [employerId], references: [id], onDelete: Cascade)
  deployments Deployment[]

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("employer_recruitment_letters")
}

model WorkerPassport {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId       String   @map("worker_id") @db.Uuid
  passportNumber String   @map("passport_number") @db.VarChar(50)
  issueDate      DateTime @map("issue_date") @db.Date
  expiryDate     DateTime @map("expiry_date") @db.Date
  issuePlace     String?  @map("issue_place") @db.VarChar(100)
  isCurrent      Boolean  @default(false) @map("is_current")

  worker Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("worker_passports")
}

model WorkerArc {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId   String   @map("worker_id") @db.Uuid
  arcNumber  String   @map("arc_number") @db.VarChar(50)
  issueDate  DateTime @map("issue_date") @db.Date
  expiryDate DateTime @map("expiry_date") @db.Date
  isCurrent  Boolean  @default(false) @map("is_current")

  worker Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("worker_arcs")
}

model Deployment {
  id                  String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId            String  @map("worker_id") @db.Uuid
  employerId          String  @map("employer_id") @db.Uuid
  recruitmentLetterId String? @map("recruitment_letter_id") @db.Uuid

  startDate     DateTime             @map("start_date") @db.Date
  endDate       DateTime?            @map("end_date") @db.Date
  status        DeploymentStatus     @default(active)
  serviceStatus ServiceStatus        @default(active_service) @map("service_status")
  sourceType    ManagementSourceType @default(direct_hiring) @map("source_type")

  jobDescription    String?   @map("job_description") @db.Text
  entryDate         DateTime? @map("entry_date") @db.Date
  entryReportSerial String?   @map("entry_report_serial") @db.VarChar(50)
  flightNumber      String?   @map("flight_number") @db.VarChar(20)
  flightArrivalDate DateTime? @map("flight_arrival_date") @db.Date
  visaLetterNo      String?   @map("visa_letter_no") @db.VarChar(50)
  jobType           String?   @map("job_type") @db.VarChar(50)
  shift             String?   @map("shift") @db.VarChar(50)

  // Overseas Recruitment Workflow Fields
  overseasCheckStatus   String?   @map("overseas_check_status") @db.VarChar(20)
  overseasCheckDate     DateTime? @map("overseas_check_date") @db.Date
  docVerificationStatus String?   @map("doc_verification_status") @db.VarChar(20)
  docSubmissionDate     DateTime? @map("doc_submission_date") @db.Date
  docVerifiedDate       DateTime? @map("doc_verified_date") @db.Date
  visaStatus            String?   @map("visa_status") @db.VarChar(20)
  visaApplicationDate   DateTime? @map("visa_application_date") @db.Date
  visaNumber            String?   @map("visa_number") @db.VarChar(50)

  // Termination Information
  terminationReason String? @map("termination_reason") @db.VarChar(50)
  terminationNotes  String? @map("termination_notes") @db.Text


  // [New] Specific Factory Location
  factoryId         String?          @map("factory_id") @db.Uuid
  factory           EmployerFactory? @relation(fields: [factoryId], references: [id])

  worker            Worker                     @relation(fields: [workerId], references: [id])
  employer          Employer                   @relation(fields: [employerId], references: [id])
  recruitmentLetter EmployerRecruitmentLetter? @relation(fields: [recruitmentLetterId], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  timelines     WorkerTimeline?
  healthChecks  HealthCheck[]
  permitDetails WorkerPermitDetail[]
  insurances    WorkerInsurance[]

  @@map("deployments")
}

// ==========================================
// [Phase 1] Pre-Permit / Component Documents
// ==========================================

model IndustryRecognition {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employerId String   @map("employer_id") @db.Uuid
  factoryId  String?  @map("factory_id") @db.Uuid // Optional: link to specific factory if multi-site

  bureauRefNumber String   @unique @map("bureau_ref_number") @db.VarChar(50) // 工業局函號
  issueDate       DateTime @map("issue_date") @db.Date // 發文日期
  
  // Tier Management
  tier          String   @map("tier") @db.VarChar(10) // A+, A, B, C, D
  expiryDate    DateTime? @map("expiry_date") @db.Date // 效期 (usually 3 years?)
  allocationRate Decimal? @map("allocation_rate") @db.Decimal(5, 2) // e.g. 0.20

  fileUrl       String?   @map("file_url") @db.Text

  // Stats
  approvedQuota Int @default(0) @map("approved_quota") 
  usedQuota     Int @default(0) @map("used_quota")

  employer        Employer         @relation(fields: [employerId], references: [id], onDelete: Cascade)
  employerFactory EmployerFactory? @relation(fields: [factoryId], references: [id])

  // Relations
  recruitmentLetters EmployerRecruitmentLetter[]

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("industry_recognitions")
}

model RecruitmentProof {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employerId String   @map("employer_id") @db.Uuid

  receiptNumber String   @unique @map("receipt_number") @db.VarChar(50) // 求才證明序號
  registerDate  DateTime @map("register_date") @db.Date // 求才登記日
  issueDate     DateTime @map("issue_date") @db.Date // 證明書發文日
  
  jobCenter     String?  @map("job_center") @db.VarChar(50) // 受理公立就業服務機構
  status        String   @default("VALID") @db.VarChar(20) // VALID, EXPIRED, USED
  
  // Fees
  reviewFeeReceiptNo String?   @map("review_fee_receipt_no") @db.VarChar(50) // 審查費收據號碼
  reviewFeePayDate   DateTime? @map("review_fee_pay_date") @db.Date

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  // Relations
  recruitmentLetters EmployerRecruitmentLetter[]

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("recruitment_proofs")
}

model PermitDocument {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employerId       String   @map("employer_id") @db.Uuid
  permitNumber     String   @unique @map("permit_number") @db.VarChar(50)
  issueDate        DateTime @map("issue_date") @db.Date
  issuingAuthority String?  @map("issuing_authority") @db.VarChar(100)

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workerPermitDetails WorkerPermitDetail[]

  @@map("permit_documents")
}

model WorkerPermitDetail {
  id               String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  permitDocumentId String     @map("permit_document_id") @db.Uuid
  deploymentId     String     @map("deployment_id") @db.Uuid
  permitType       PermitType @map("permit_type")
  startDate        DateTime   @map("start_date") @db.Date
  endDate          DateTime   @map("end_date") @db.Date

  permitDocument PermitDocument @relation(fields: [permitDocumentId], references: [id], onDelete: Cascade)
  deployment     Deployment     @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("worker_permit_details")
}

model WorkerTimeline {
  id           String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  deploymentId String @unique @map("deployment_id") @db.Uuid

  // 1. Entry Phase Deadlines
  entryMedCheckDeadline DateTime? @map("entry_med_check_deadline") @db.Date
  empPermitDeadline     DateTime? @map("emp_permit_deadline") @db.Date
  arcDeadline           DateTime? @map("arc_deadline") @db.Date

  // 2. Regular Checks (Legacy names preserved, mapped to specific months)
  medCheck6moDeadline  DateTime? @map("med_check_6mo_deadline") @db.Date // 6 months
  medCheck18moDeadline DateTime? @map("med_check_18mo_deadline") @db.Date // 18 months
  medCheck30moDeadline DateTime? @map("med_check_30mo_deadline") @db.Date // 30 months

  // 3. Document Expiries (Data driven)
  residencePermitExpiry DateTime? @map("residence_permit_expiry") @db.Date
  passportExpiry        DateTime? @map("passport_expiry") @db.Date

  // 4. Renewal Phase
  renewalWindowStart DateTime? @map("renewal_window_start") @db.Date // End - 4 months
  renewalWindowEnd   DateTime? @map("renewal_window_end") @db.Date // End - 2 months

  deployment Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("worker_timelines")
}

model HealthCheck {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId     String            @map("worker_id") @db.Uuid
  deploymentId String            @map("deployment_id") @db.Uuid
  checkType    HealthCheckType   @map("check_type")
  checkDate    DateTime          @map("check_date") @db.Date
  hospitalName String?           @map("hospital_name") @db.VarChar(100)
  result       HealthCheckResult @default(pending)
  reportDate   DateTime?         @map("report_date") @db.Date
  failReason   String?           @map("fail_reason") @db.Text

  worker     Worker     @relation(fields: [workerId], references: [id], onDelete: Cascade)
  deployment Deployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("health_checks")
}

model Incident {
  id            String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId      String?          @map("worker_id") @db.Uuid
  employerId    String?          @map("employer_id") @db.Uuid
  description   String           @db.Text
  severityLevel IncidentSeverity @map("severity_level")
  status        IncidentStatus   @default(open)
  incidentDate  DateTime         @default(now()) @map("incident_date") @db.Timestamptz

  isAutoGenerated Boolean @default(false) @map("is_auto_generated")
  sourceRefId     String? @map("source_ref_id") @db.Uuid
  category        String? @map("category") @db.VarChar(50)

  worker   Worker?   @relation(fields: [workerId], references: [id])
  employer Employer? @relation(fields: [employerId], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("incidents")
}

model ServiceAssignment {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employerId     String?       @map("employer_id") @db.Uuid
  workerId       String?       @map("worker_id") @db.Uuid
  internalUserId String        @map("internal_user_id") @db.Uuid
  role           StaffRoleType
  startDate      DateTime      @default(now()) @map("start_date") @db.Date
  endDate        DateTime?     @map("end_date") @db.Date
  notes          String?       @db.Text

  employer     Employer?    @relation(fields: [employerId], references: [id], onDelete: Cascade)
  worker       Worker?      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  internalUser InternalUser @relation("ServiceAssignedUser", fields: [internalUserId], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("service_assignments")
}

model WorkerInsurance {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId      String        @map("worker_id") @db.Uuid
  deploymentId  String?       @map("deployment_id") @db.Uuid
  type          InsuranceType
  providerName  String?       @map("provider_name") @db.VarChar(50)
  policyNumber  String?       @map("policy_number") @db.VarChar(50)
  insuredAmount Decimal?      @map("insured_amount") @db.Decimal(10, 2)
  startDate     DateTime      @map("start_date") @db.Date
  endDate       DateTime?     @map("end_date") @db.Date

  worker     Worker      @relation(fields: [workerId], references: [id], onDelete: Cascade)
  deployment Deployment? @relation(fields: [deploymentId], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("worker_insurances")
}

model WorkerAddressHistory {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId      String      @map("worker_id") @db.Uuid
  addressType   AddressType @map("address_type")
  addressDetail String      @map("address_detail") @db.Text
  startDate     DateTime    @map("start_date") @db.Date
  endDate       DateTime?   @map("end_date") @db.Date

  worker Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("worker_address_history")
}

model JobOrder {
  id                       String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  employerId               String         @map("employer_id") @db.Uuid
  orderDate                DateTime       @default(now()) @map("order_date") @db.Date
  requiredWorkers          Int            @map("required_workers")
  expectedArrivalDate      DateTime?      @map("expected_arrival_date") @db.Date
  localRecruitmentDeadline DateTime?      @map("local_recruitment_deadline") @db.Date
  status                   JobOrderStatus @default(open)

  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  createdBy     String?       @map("created_by") @db.Uuid
  updatedBy     String?       @map("updated_by") @db.Uuid
  createdByUser InternalUser? @relation("JobOrderCreatedBy", fields: [createdBy], references: [id])
  updatedByUser InternalUser? @relation("JobOrderUpdatedBy", fields: [updatedBy], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  interviews Interview[]

  @@map("job_orders")
}

model WorkerEvent {
  id        String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId  String          @map("worker_id") @db.Uuid
  eventType WorkerEventType @map("event_type")
  
  eventDate       DateTime? @map("event_date") @db.Date // 發生日期
  reportDate      DateTime? @map("report_date") @db.Date // 通報日期/登記日
  
  bureauRefNumber String?   @map("bureau_ref_number") @db.VarChar(50) // 核備文號
  bureauRefDate   DateTime? @map("bureau_ref_date") @db.Date // 核備函文日期

  notes   String? @db.Text
  fileUrl String? @map("file_url") @db.Text

  worker Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("worker_events")
}

model Interview {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  jobOrderId    String   @map("job_order_id") @db.Uuid
  interviewDate DateTime @map("interview_date") @db.Timestamptz
  location      String?  @db.Text
  interviewer   String?  @db.VarChar(100)

  jobOrder JobOrder @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  candidates InterviewCandidate[]

  @@map("interviews")
}

model InterviewCandidate {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  interviewId String          @map("interview_id") @db.Uuid
  workerId    String          @map("worker_id") @db.Uuid
  result      CandidateResult @default(pending)
  remarks     String?         @db.Text

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  worker    Worker    @relation(fields: [workerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([interviewId, workerId])
  @@map("interview_candidates")
}

model SystemComment {
  id              String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recordId        String @map("record_id") @db.Uuid
  recordTableName String @map("record_table_name") @db.VarChar(50)
  content         String @db.Text

  createdBy String       @map("created_by") @db.Uuid
  author    InternalUser @relation("CommentAuthor", fields: [createdBy], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  mentions CommentMention[]

  @@index([recordTableName, recordId])
  @@map("system_comments")
}

model CommentMention {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  commentId       String  @map("comment_id") @db.Uuid
  mentionedUserId String  @map("mentioned_user_id") @db.Uuid
  isRead          Boolean @default(false) @map("is_read")

  comment SystemComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    InternalUser  @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@unique([commentId, mentionedUserId])
  @@map("comment_mentions")
}

model Attachment {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  refId    String @map("ref_id") @db.Uuid
  refTable String @map("ref_table") @db.VarChar(50)

  filePath String  @map("file_path") @db.Text
  fileName String  @map("file_name") @db.VarChar(255)
  fileType String? @map("file_type") @db.VarChar(100)

  uploaderId String?  @map("uploader_id") @db.Uuid
  uploadedAt DateTime @default(now()) @map("uploaded_at") @db.Timestamptz

  @@index([refTable, refId])
  @@map("attachments")
}

model Hospital {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code       String?   @unique @db.VarChar(50)
  name       String    @db.VarChar(255)
  city       String?   @db.VarChar(50)
  country    String?   @db.VarChar(50)
  validUntil DateTime? @map("valid_until") @db.Date

  isGeneral  Boolean @default(false) @map("is_general")
  isXray     Boolean @default(false) @map("is_xray")
  isOverseas Boolean @default(false) @map("is_overseas")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("hospitals")
}

// Tax Configuration (Annual Parameters)
model TaxConfig {
  id                            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  year                          Int      @unique
  minWage                       Int      @map("min_wage")
  minWageThresholdMultiplier    Float    @default(1.5) @map("min_wage_threshold_multiplier")
  standardDeduction             Int      @map("standard_deduction")
  salaryDeduction               Int      @map("salary_deduction")
  personalExemption             Int      @map("personal_exemption")
  taxRateResident               Float    @map("tax_rate_resident")
  nonResidentLowRate            Float    @map("non_resident_low_rate")
  nonResidentHighRate           Float    @map("non_resident_high_rate")
  effectiveDate                 DateTime @map("effective_date") @db.Date
  notes                         String?  @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("tax_configs")
}

// Fee Items (Official Fees by Nationality)
model FeeItem {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String  @db.VarChar(255)
  defaultAmount Int     @map("default_amount")
  category      String  @db.VarChar(50) // 'official_fee', 'service_fee', etc.
  nationality   String? @db.VarChar(10) // Null = applies to all
  description   String? @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("fee_items")
}

// Insurance Tiers (Labor + Health Insurance Rates by Salary Grade)
model InsuranceTier {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  grade     Int    @unique
  minSalary Int    @map("min_salary")
  maxSalary Int    @map("max_salary")
  laborFee  Int    @map("labor_fee")
  healthFee Int    @map("health_fee")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("insurance_tiers")
}

// Document Templates (Contracts, Forms, etc.)
model DocumentTemplate {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @db.VarChar(255)
  category    String   @db.VarChar(100) // 'entry_packet', 'contract', 'permit_app', etc.
  filePath    String   @map("file_path") @db.Text
  nationality String?  @db.VarChar(10) // Null = applies to all
  isActive    Boolean  @default(true) @map("is_active")
  description String?  @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("document_templates")
}
