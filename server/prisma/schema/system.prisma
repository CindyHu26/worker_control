// ==========================================
// System Features (Alerts, Comments, Compliance)
// ==========================================

model SystemComment {
  id String @id @default(uuid()) @db.Uuid

  // Entity Mapping
  entityType CommentEntityType @map("entity_type")
  entityId   String            @map("entity_id") @db.Uuid

  // Content
  content String @db.Text

  // Author
  authorId String       @map("author_id") @db.Uuid
  author   InternalUser @relation("CommentAuthor", fields: [authorId], references: [id])

  // Soft Delete
  isDeleted Boolean @default(false) @map("is_deleted")

  // Mentions
  mentions CommentMention[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([entityType, entityId])
  @@index([authorId])
  @@map("system_comments")
}

model CommentMention {
  id String @id @default(uuid()) @db.Uuid

  commentId String @map("comment_id") @db.Uuid
  userId    String @map("user_id") @db.Uuid

  // Read Status
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at") @db.Timestamptz

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  comment SystemComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    InternalUser  @relation("MentionedUser", fields: [userId], references: [id])

  @@unique([commentId, userId])
  @@index([userId, isRead])
  @@map("comment_mentions")
}

model SystemAlert {
  id String @id @default(uuid()) @db.Uuid

  // 關聯實體
  entityType CommentEntityType @map("entity_type")
  entityId   String            @map("entity_id") @db.Uuid

  // 警報內容與批注
  severity    AlertSeverity
  title       String        @db.VarChar(100)
  description String?       @db.Text

  // 到期日/觸發條件
  dueDate   DateTime? @map("due_date") @db.Date
  alertType String    @map("alert_type") @db.VarChar(50) // e.g., "ARC_EXPIRY", "HEALTH_CHECK", "ENTRY_REPORT"

  // 狀態
  status         AlertStatus @default(OPEN)
  acknowledgedBy String?     @map("acknowledged_by") @db.Uuid
  acknowledgedAt DateTime?   @map("acknowledged_at") @db.Timestamptz
  resolvedAt     DateTime?   @map("resolved_at") @db.Timestamptz

  // 系統時戳
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([severity, status])
  @@index([entityType, entityId])
  @@index([dueDate])
  @@map("system_alerts")
}

model Incident {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  workerId String? @map("worker_id") @db.Uuid

  employerId String? @map("employer_id") @db.Uuid

  description String @db.Text

  severityLevel IncidentSeverity @map("severity_level")

  status IncidentStatus @default(open)

  incidentDate DateTime @default(now()) @map("incident_date") @db.Timestamptz

  isAutoGenerated Boolean @default(false) @map("is_auto_generated")

  sourceRefId String? @map("source_ref_id") @db.Uuid

  category String? @map("category") @db.VarChar(50)

  worker Worker? @relation(fields: [workerId], references: [id])

  employer Employer? @relation(fields: [employerId], references: [id])

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("incidents")
}

model ComplianceRule {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  code String @unique @db.VarChar(50)

  value String @db.VarChar(255)

  category String @db.VarChar(50)

  description String? @db.Text

  effectiveDate DateTime @default(now()) @map("effective_date") @db.Date

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz
  createdBy String?  @map("created_by") @db.Uuid

  @@map("compliance_rules")
}

model OfficialAgency {
  id String @id @default(uuid()) @db.Uuid

  code String @unique @db.VarChar(50) // e.g., "MOL", "NIA"

  name String @db.VarChar(100) // e.g., "Ministry of Labor"

  nameEn String? @map("name_en") @db.VarChar(100)

  address String? @db.Text

  phone String? @db.VarChar(50)

  website String? @db.VarChar(200)

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz
  createdBy String?  @map("created_by") @db.Uuid

  // Relations

  personnel OfficialAgencyPerson[]

  @@map("official_agencies")
}

model OfficialAgencyPerson {
  id String @id @default(uuid()) @db.Uuid

  agencyId String @map("agency_id") @db.Uuid

  agency OfficialAgency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  // Personal Info

  name String @db.VarChar(50)

  nameEn String? @map("name_en") @db.VarChar(100)

  title String? @db.VarChar(100) // e.g., "Minister", "Director"

  titleEn String? @map("title_en") @db.VarChar(100)

  // Tenure & Status

  startDate DateTime? @map("start_date") @db.Date

  endDate DateTime? @map("end_date") @db.Date

  isActing Boolean @default(false) @map("is_acting")

  actingNotes String? @map("acting_notes") @db.Text

  sortOrder Int @default(0) @map("sort_order")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("official_agency_personnel")
}
